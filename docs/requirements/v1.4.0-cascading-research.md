# KATASHIRO v1.4.0 要件定義書

## カスケード型リサーチワークフロー（Cascading Research Workflow）

**バージョン**: 1.4.0  
**作成日**: 2026-01-14  
**ステータス**: Draft

---

## 1. 概要

### 1.1 背景

v1.2.0/v1.3.0の合議型リサーチ（ConsensusResearchEngine）は「3エージェント × 3イテレーション」の並列実行モデルを採用していた。しかし、各イテレーションが独立しており、前のイテレーションの知見を十分に活用できていなかった。

### 1.2 目的

v1.4.0では**カスケード型（滝型）リサーチワークフロー**を導入し、各ステップが前ステップの結果を参照しながら段階的に深掘りする調査手法を実現する。

### 1.3 ワークフロー概要

```
Step 1: 5エージェント並列調査（初期調査）
    ↓ 結果を統合
Step 2: 5エージェント並列調査（Step 1参照）
    ↓ 結果を統合
Step 3: 5エージェント並列調査（Step 2参照）
    ↓ 結果を統合
Step 4: 5エージェント並列調査（Step 3参照）
    ↓ 結果を統合
Step 5: 5エージェント並列調査（Step 4参照）
    ↓ 結果を統合
最終レポート生成（Step 5結果ベース）
```

---

## 2. 機能要件

### 2.1 CascadingResearchEngine（REQ-1.4.0-CRE-001）

| 要件ID | 要件名 | 説明 | 優先度 |
|--------|--------|------|--------|
| REQ-1.4.0-CRE-001 | エンジン基盤 | カスケード型リサーチの実行エンジン | P0 |
| REQ-1.4.0-CRE-002 | 5ステップ実行 | 5つのステップを順次実行 | P0 |
| REQ-1.4.0-CRE-003 | コンテキスト伝播 | 前ステップの結果を次ステップに伝播 | P0 |
| REQ-1.4.0-CRE-004 | イベント発行 | 進捗イベントの発行 | P1 |
| REQ-1.4.0-CRE-005 | 設定可能性 | ステップ数・エージェント数の設定 | P1 |

### 2.2 StepExecutor（REQ-1.4.0-STE-001）

| 要件ID | 要件名 | 説明 | 優先度 |
|--------|--------|------|--------|
| REQ-1.4.0-STE-001 | ステップ実行 | 1ステップ内で5エージェントを並列実行 | P0 |
| REQ-1.4.0-STE-002 | コンテキスト注入 | 前ステップの結果をエージェントに注入 | P0 |
| REQ-1.4.0-STE-003 | 結果統合 | 5エージェントの結果を統合 | P0 |
| REQ-1.4.0-STE-004 | タイムアウト | ステップ単位のタイムアウト制御 | P1 |

### 2.3 CascadingAgent（REQ-1.4.0-AGT-001）

| 要件ID | 要件名 | 説明 | 優先度 |
|--------|--------|------|--------|
| REQ-1.4.0-AGT-001 | 役割分担 | 5つの異なる視点を持つエージェント | P0 |
| REQ-1.4.0-AGT-002 | コンテキスト活用 | 前ステップの結果を参照した調査 | P0 |
| REQ-1.4.0-AGT-003 | ギャップ分析 | 前ステップで不足している情報の特定 | P0 |
| REQ-1.4.0-AGT-004 | 深掘り調査 | 特定トピックの詳細調査 | P1 |

### 2.4 StepResultIntegrator（REQ-1.4.0-INT-001）

| 要件ID | 要件名 | 説明 | 優先度 |
|--------|--------|------|--------|
| REQ-1.4.0-INT-001 | 結果統合 | 5エージェントの結果を1つに統合 | P0 |
| REQ-1.4.0-INT-002 | 重複除去 | 重複情報の除去 | P0 |
| REQ-1.4.0-INT-003 | 矛盾解決 | 矛盾情報の解決 | P1 |
| REQ-1.4.0-INT-004 | 要約生成 | ステップ結果の要約生成 | P1 |

### 2.5 FinalReportGenerator（REQ-1.4.0-FRG-001）

| 要件ID | 要件名 | 説明 | 優先度 |
|--------|--------|------|--------|
| REQ-1.4.0-FRG-001 | 最終レポート | Step 5の結果から最終レポート生成 | P0 |
| REQ-1.4.0-FRG-002 | 全ステップ参照 | 必要に応じて全ステップの情報を参照 | P1 |
| REQ-1.4.0-FRG-003 | 後処理統合 | v1.3.0の後処理（ASCII変換）を統合 | P0 |

---

## 3. エージェント役割定義

### 3.1 5エージェントの役割

| エージェント | 役割 | 検索戦略 | 重点 |
|-------------|------|----------|------|
| **Agent 1: Official** | 公式情報収集 | 公式サイト、プレスリリース | 一次情報の正確性 |
| **Agent 2: News** | ニュース収集 | ニュースサイト、速報 | 最新性 |
| **Agent 3: Analysis** | 分析・考察収集 | 分析記事、専門家意見 | 深い洞察 |
| **Agent 4: Academic** | 学術情報収集 | 論文、研究レポート | 学術的裏付け |
| **Agent 5: Community** | コミュニティ情報 | フォーラム、SNS、口コミ | 実態・評判 |

### 3.2 ステップごとの調査フォーカス

| ステップ | フォーカス | 説明 | queryModifiers |
|---------|-----------|------|----------------|
| **Step 1** | overview | トピックの全体像を把握 | `['概要', '入門', 'とは', '基本']` |
| **Step 2** | detail | Step 1で発見した主要トピックを深掘り | `['詳細', '仕組み', '技術', '方法']` |
| **Step 3** | gap | Step 2で不足している情報を補完 | `['課題', '問題', '懸念', 'リスク']` |
| **Step 4** | verify | 情報の正確性を検証、矛盾を解決 | `['検証', '比較', '評価', '実績']` |
| **Step 5** | integrate | 全情報を統合し結論を導出 | `['まとめ', '結論', '展望', '将来']` |

---

## 4. データフロー

### 4.1 基本型定義

```typescript
/** 発見事項 */
interface Finding {
  id: string;                   // 一意識別子
  content: string;              // 発見内容
  source: Source;               // 情報ソース
  confidence: number;           // 信頼度 (0-1)
  stepNumber: number;           // 発見されたステップ
  agentId: string;              // 発見したエージェント
  category: FindingCategory;    // カテゴリ
  timestamp: string;            // 発見日時
}

type FindingCategory = 'fact' | 'opinion' | 'analysis' | 'question' | 'contradiction';

/** 情報ソース */
interface Source {
  url: string;                  // ソースURL
  title: string;                // ページタイトル
  fetchedAt: string;            // 取得日時
  credibility: number;          // 信頼度スコア (0-1)
  domain: string;               // ドメイン
}

/** エージェントレポート */
interface CascadingAgentReport {
  agentId: string;              // エージェントID
  role: AgentRole;              // エージェントの役割
  stepNumber: number;           // ステップ番号
  content: string;              // レポート本文
  findings: Finding[];          // 発見事項
  sources: Source[];            // 使用ソース
  gaps: string[];               // 発見したギャップ
  durationMs: number;           // 実行時間
  timestamp: string;            // 完了日時
}

type AgentRole = 'official' | 'news' | 'analysis' | 'academic' | 'community';
```

### 4.2 ステップ間のデータ伝播

```typescript
/** ステップフォーカス */
type StepFocus = 'overview' | 'detail' | 'gap' | 'verify' | 'integrate';

/** ステップコンテキスト */
interface StepContext {
  stepNumber: number;               // 現在のステップ番号 (1-5)
  topic: string;                    // 調査トピック
  stepFocus: StepFocus;             // このステップのフォーカス
  previousStepResult?: StepResult;  // 直前ステップの結果
  allPreviousResults: StepResult[]; // 全ステップの結果（累積）
  accumulatedFindings: Finding[];   // 累積発見事項
  identifiedGaps: string[];         // 特定されたギャップ
  keyEntities: string[];            // 重要エンティティ
  unresolvedQuestions: string[];    // 未解決の疑問
  queryModifiers: string[];         // このステップの検索修飾子
}

/** ステップ結果 */
interface StepResult {
  stepNumber: number;
  stepFocus: StepFocus;
  agentReports: CascadingAgentReport[];  // 5エージェントのレポート
  integratedSummary: string;        // 統合要約
  newFindings: Finding[];           // 新規発見事項
  newGaps: string[];                // 新たに特定されたギャップ
  resolvedGaps: string[];           // 解決されたギャップ
  confidence: number;               // 信頼度スコア (0-1)
  contradictions: Contradiction[];  // 検出された矛盾
  timestamp: string;
}

/** 矛盾情報 */
interface Contradiction {
  id: string;
  finding1: Finding;
  finding2: Finding;
  description: string;
  resolved: boolean;
  resolution?: string;
}
```

### 4.3 最終結果構造

```typescript
interface CascadingResearchResult {
  topic: string;
  steps: StepResult[];          // 5ステップの結果
  finalReport: string;          // 最終レポート
  totalFindings: Finding[];     // 全発見事項
  totalSources: Source[];       // 全ソース
  resolvedContradictions: Contradiction[];  // 解決された矛盾
  unresolvedContradictions: Contradiction[]; // 未解決の矛盾
  executionMetrics: {
    totalDurationMs: number;
    stepDurations: number[];
    totalAgentRuns: number;
    findingsPerStep: number[];
  };
  metadata: {
    version: string;            // "1.4.0"
    startedAt: string;
    completedAt: string;
    engineType: 'cascading';
  };
}
```

---

## 5. 設定オプション

```typescript
interface CascadingResearchConfig {
  // ステップ設定
  stepCount: number;              // デフォルト: 5
  agentCount: number;             // デフォルト: 5
  
  // タイムアウト設定
  stepTimeoutMs: number;          // デフォルト: 300000 (5分)
  agentTimeoutMs: number;         // デフォルト: 60000 (1分)
  
  // 検索設定
  searchConfig: {
    provider: 'duckduckgo' | 'searxng';
    maxResultsPerAgent: number;   // デフォルト: 10
  };
  
  // 後処理設定（v1.3.0互換）
  postProcess: PostProcessorOptions;
  
  // エージェント戦略（ロール別）
  agentStrategies?: AgentStrategy[];
  
  // ステップ別戦略（オプション）
  stepStrategies?: {
    [stepNumber: number]: {
      focus: StepFocus;
      queryModifiers: string[];
      maxResultsPerAgent: number;
      priorityAgents?: AgentRole[];  // 優先エージェント
    };
  };
  
  // 早期終了（オプション）
  earlyTermination?: {
    enabled: boolean;
    confidenceThreshold: number;  // この信頼度に達したら終了 (0-1)
    minSteps: number;             // 最低実行ステップ数（デフォルト: 3）
  };
}

/** デフォルトステップ戦略 */
const DEFAULT_STEP_STRATEGIES: Record<number, StepStrategyConfig> = {
  1: { focus: 'overview', queryModifiers: ['概要', '入門', 'とは', '基本'], maxResultsPerAgent: 10 },
  2: { focus: 'detail', queryModifiers: ['詳細', '仕組み', '技術', '方法'], maxResultsPerAgent: 10 },
  3: { focus: 'gap', queryModifiers: ['課題', '問題', '懸念', 'リスク'], maxResultsPerAgent: 8 },
  4: { focus: 'verify', queryModifiers: ['検証', '比較', '評価', '実績'], maxResultsPerAgent: 8 },
  5: { focus: 'integrate', queryModifiers: ['まとめ', '結論', '展望', '将来'], maxResultsPerAgent: 5 },
};
```

### 5.1 信頼度スコア計算

```typescript
/**
 * 信頼度スコア計算ロジック
 * 
 * confidence = (
 *   sourceCredibilityAvg * 0.3 +      // ソースの平均信頼度
 *   findingConsistency * 0.3 +         // 発見事項の一貫性（矛盾の少なさ）
 *   coverageScore * 0.2 +              // カバレッジ（5エージェント全てが貢献）
 *   gapResolutionRate * 0.2            // ギャップ解決率
 * )
 */
function calculateStepConfidence(stepResult: StepResult): number {
  const sourceCredibilityAvg = average(stepResult.agentReports.flatMap(r => r.sources.map(s => s.credibility)));
  const findingConsistency = 1 - (stepResult.contradictions.length * 0.1);
  const coverageScore = stepResult.agentReports.filter(r => r.findings.length > 0).length / 5;
  const gapResolutionRate = stepResult.resolvedGaps.length / (stepResult.resolvedGaps.length + stepResult.newGaps.length) || 0;
  
  return Math.max(0, Math.min(1,
    sourceCredibilityAvg * 0.3 +
    findingConsistency * 0.3 +
    coverageScore * 0.2 +
    gapResolutionRate * 0.2
  ));
}
```

---

## 6. イベント定義

```typescript
type CascadingResearchEvent =
  | { type: 'researchStarted'; topic: string; config: CascadingResearchConfig }
  | { type: 'stepStarted'; stepNumber: number; context: StepContext }
  | { type: 'agentStarted'; stepNumber: number; agentId: string }
  | { type: 'agentCompleted'; stepNumber: number; agentId: string; durationMs: number }
  | { type: 'stepIntegrating'; stepNumber: number }
  | { type: 'stepCompleted'; stepNumber: number; result: StepResult }
  | { type: 'finalReportGenerating' }
  | { type: 'researchCompleted'; result: CascadingResearchResult };
```

---

## 7. クラス設計

### 7.1 ファイル構成

```
packages/orchestrator/src/
├── cascading/
│   ├── CascadingResearchEngine.ts    # メインエンジン
│   ├── StepExecutor.ts               # ステップ実行
│   ├── CascadingAgent.ts             # エージェント
│   ├── StepResultIntegrator.ts       # 結果統合
│   ├── types.ts                      # 型定義
│   └── index.ts                      # エクスポート
├── consensus/                         # v1.2.0/v1.3.0（既存）
│   └── ...
└── index.ts                          # 更新
```

### 7.2 クラス図

```
┌─────────────────────────────────────────────────────────────┐
│                  CascadingResearchEngine                    │
├─────────────────────────────────────────────────────────────┤
│ - config: CascadingResearchConfig                           │
│ - stepExecutor: StepExecutor                                │
│ - integrator: StepResultIntegrator                          │
│ - postProcessor: ReportPostProcessor                        │
├─────────────────────────────────────────────────────────────┤
│ + research(topic: string): Promise<CascadingResearchResult> │
│ + on(listener: EventListener): void                         │
│ - executeStep(context: StepContext): Promise<StepResult>    │
│ - generateFinalReport(steps: StepResult[]): Promise<string> │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ uses
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      StepExecutor                           │
├─────────────────────────────────────────────────────────────┤
│ - agents: CascadingAgent[]                                  │
├─────────────────────────────────────────────────────────────┤
│ + execute(context: StepContext): Promise<AgentReport[]>     │
│ - runAgentsInParallel(context: StepContext): Promise<...>   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ uses
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     CascadingAgent                          │
├─────────────────────────────────────────────────────────────┤
│ - id: string                                                │
│ - role: AgentRole                                           │
│ - strategy: AgentStrategy                                   │
│ - searchClient: WebSearchClient                             │
│ - scraper: WebScraper                                       │
├─────────────────────────────────────────────────────────────┤
│ + research(context: StepContext): Promise<AgentReport>      │
│ - buildQuery(context: StepContext): string                  │
│ - analyzeGaps(context: StepContext): string[]               │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 非機能要件

### 8.1 パフォーマンス

| 要件 | 目標値 |
|------|--------|
| 1ステップの実行時間 | < 60秒（5エージェント並列） |
| 全5ステップの実行時間 | < 5分 |
| メモリ使用量 | < 512MB |

### 8.2 信頼性

| 要件 | 説明 |
|------|------|
| エージェント障害耐性 | 1-2エージェントが失敗しても続行 |
| リトライ | 各エージェントは最大3回リトライ |
| タイムアウト | ステップ/エージェント単位でタイムアウト |
| 部分結果保存 | 途中でエラーになっても、完了したステップの結果は保持 |

### 8.3 テスト要件

| 要件 | 目標 |
|------|------|
| ユニットテストカバレッジ | > 80% |
| 統合テスト | 主要ワークフローのE2Eテスト |
| モックテスト | 外部API依存のモック化 |
| **目標テスト数** | **50テスト以上** |

### 8.4 テスト内訳

| ファイル | テスト数 | 内容 |
|---------|---------|------|
| types.test.ts | 5 | 型定義・デフォルト値 |
| CascadingAgent.test.ts | 12 | エージェント動作 |
| StepExecutor.test.ts | 10 | ステップ実行・並列処理 |
| StepResultIntegrator.test.ts | 10 | 結果統合・矛盾検出 |
| CascadingResearchEngine.test.ts | 13 | E2E・イベント・早期終了 |

---

## 9. マイルストーン

| フェーズ | 内容 | 期間 |
|---------|------|------|
| Phase 1 | 型定義・インターフェース設計 | Day 1 |
| Phase 2 | CascadingAgent実装 | Day 1-2 |
| Phase 3 | StepExecutor実装 | Day 2 |
| Phase 4 | StepResultIntegrator実装 | Day 2-3 |
| Phase 5 | CascadingResearchEngine実装 | Day 3 |
| Phase 6 | テスト・ドキュメント | Day 3-4 |
| Phase 7 | 統合・リリース | Day 4 |

---

## 10. 後方互換性

- v1.2.0/v1.3.0の`ConsensusResearchEngine`は維持
- 新しい`CascadingResearchEngine`を追加
- 両方のエンジンを選択可能
- `ReportPostProcessor`は共通で使用
- `ReportScorer`の矛盾検出ロジックを`StepResultIntegrator`で再利用

---

## 11. v1.2.0コンポーネントの再利用

| コンポーネント | 再利用方法 |
|---------------|-----------|
| `ReportScorer` | 矛盾検出ロジックを`StepResultIntegrator`で使用 |
| `ReportPostProcessor` | 最終レポート生成時に使用（v1.3.0） |
| `WebSearchClient` | エージェントの検索に使用 |
| `WebScraper` | エージェントのスクレイピングに使用 |
| `TextAnalyzer` | コンテンツ分析に使用 |
| `EntityExtractor` | キーエンティティ抽出に使用 |

---

## 12. 承認

| 役割 | 名前 | 日付 | 承認 |
|------|------|------|------|
| 開発者 | - | 2026-01-14 | 待機中 |
| レビュアー | - | - | 待機中 |

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 0.1 | 2026-01-14 | 初版作成 |
| 0.2 | 2026-01-14 | レビュー指摘反映: Finding/Source型追加、StepContext拡張、信頼度計算ロジック追加、テスト目標追加 |
