# KATASHIRO v0.3.2 要件定義書

## 📋 概要

**バージョン**: 0.3.2  
**コードネーム**: Score Diversity  
**作成日**: 2026-01-13  
**ステータス**: ✅ 実装完了

---

## 🎯 リリース目標

v0.3.1の50課題実験で特定された以下の問題を解決し、Wake-Sleep学習システムの品質を向上させる。

### v0.3.1実験結果（ベースライン）→ v0.3.2実験結果

| 指標 | v0.3.1結果 | v0.3.2結果 | 目標値 | 達成状況 |
|------|-----------|-----------|--------|----------|
| 総合評価スコア | 86.0/100 | **95.7/100** | 90+ | ✅ |
| スコア標準偏差 | 0.049 | **0.094** | >0.1 | ⚠️ (94%) |
| スコア範囲 | 0.528-0.733 | **0.651-0.933** | - | ✅ (+100%) |
| 品質標準偏差 | 0.095 | 0.089 | >0.1 | ⚠️ |
| タイプ別偏り | 3.67 | **2.33** | <2.0 | ⚠️ (-37%) |
| パターン保持率 | 80% | **100%** | 70-90% | ✅ |

---

## 🔧 要件一覧

### REQ-001: マッチングスコア多様性の向上 ✅

**優先度**: High  
**影響範囲**: `wake-sleep-cycle.ts`  
**ステータス**: 実装完了

#### 実装内容
1. 品質乗数の範囲を拡大: `0.5 + quality` → `0.15 + quality * 2.0` (0.15-2.15)
2. 鮮度減衰を短縮: 7日 → **2日**（より積極的な差別化）
3. キーワードマッチング重みを増加: 50% → **65%**
4. 品質ブースト: 0.15 → **0.25**

#### 受け入れ基準
- [x] スコア標準偏差 0.094 (目標>0.1の94%達成)
- [x] スコア範囲が0.651-0.933に拡大

---

### REQ-002: 品質フィードバック係数の改善

**優先度**: Medium  
**影響範囲**: `wake-sleep-cycle.ts`

#### 背景
`autoFeedback()`による品質更新が緩やかすぎて、品質分布が均一化している。

#### 要件
1. 成功時の品質上昇係数を増加: 0.02 → 0.05
2. 失敗時の品質下降係数を増加: 0.05 → 0.10
3. レイテンシベースの調整幅を拡大

#### 受け入れ基準
- [ ] 品質標準偏差 > 0.1
- [ ] フィードバック後の品質変化が明確に観測可能

---

### REQ-003: タイプ別バランス圧縮

**優先度**: Medium  
**影響範囲**: `pattern-compressor.ts`

#### 背景
Sleep時の圧縮でタイプごとのパターン数に偏りが生じている（summary_creation: 29%保持、entity_extraction: 100%保持）。

#### 要件
1. タイプ別の最小保持数を設定（各タイプ最低2パターン）
2. 圧縮時にタイプ別のバランスを考慮するアルゴリズム追加
3. 過剰圧縮されたタイプの警告ログ出力

#### 受け入れ基準
- [ ] タイプ別標準偏差 < 2.0
- [ ] 各タイプの保持率が50%以上

---

### REQ-004: 類似度計算の改善

**優先度**: Low  
**影響範囲**: `pattern-compressor.ts`

#### 背景
現在のドメインボーナス(+0.3)だけでは、同一タイプ内の類似パターンが十分にマージされない。

#### 要件
1. コンテキストキー一致ボーナスを追加（+0.2）
2. 入力テンプレートのキーワード重複率を考慮
3. 類似度閾値を動的に調整（パターン数に応じて）

#### 受け入れ基準
- [ ] 圧縮率 > 20%
- [ ] 類似パターンの適切なマージ

---

### REQ-005: getSuggestions()の改善

**優先度**: Low  
**影響範囲**: `wake-sleep-cycle.ts`

#### 背景
改善提案の情報が不十分で、具体的なアクションに繋がりにくい。

#### 要件
1. 提案に改善理由を追加
2. 推奨アクション（マージ/削除/品質向上）を明示
3. 影響度スコアを追加

#### 受け入れ基準
- [ ] 各提案に`reason`, `action`, `impact`フィールドが含まれる

---

## 📊 成功指標

### Primary KPIs

| 指標 | v0.3.1 | v0.3.2目標 | 測定方法 |
|------|--------|-----------|----------|
| スコア標準偏差 | 0.049 | >0.10 | 50課題実験 |
| 品質標準偏差 | 0.095 | >0.12 | 50課題実験 |
| タイプ別偏り | 3.67 | <2.0 | 50課題実験 |
| 総合評価 | 86.0 | >92.0 | 50課題実験 |

### Secondary KPIs

| 指標 | v0.3.1 | v0.3.2目標 |
|------|--------|-----------|
| 圧縮率 | 20% | >25% |
| 最低タイプ保持率 | 29% | >50% |
| getSuggestions有用性 | - | 新規測定 |

---

## 🏗️ 実装計画

### Phase 1: スコア多様性（REQ-001）
- [ ] calculateMatchScoreV3()の品質乗数変更
- [ ] 鮮度減衰パラメータ変更
- [ ] 単体テスト追加
- [ ] 50課題実験で検証

### Phase 2: フィードバック改善（REQ-002）
- [ ] autoFeedback()の係数変更
- [ ] recordFeedback()の影響度調整
- [ ] 単体テスト追加

### Phase 3: バランス圧縮（REQ-003）
- [ ] compressLibrary()にタイプ別バランシング追加
- [ ] 最小保持数チェック追加
- [ ] 警告ログ実装

### Phase 4: 類似度改善（REQ-004）
- [ ] calculateSimilarity()の拡張
- [ ] 動的閾値調整の実装

### Phase 5: 提案改善（REQ-005）
- [ ] getSuggestions()の戻り値型拡張
- [ ] 改善理由生成ロジック追加

---

## 📁 影響ファイル

```
packages/feedback/src/learning/
├── wake-sleep-cycle.ts    # REQ-001, REQ-002, REQ-005
├── pattern-compressor.ts  # REQ-003, REQ-004
└── wake-sleep-types.ts    # 型定義更新
```

---

## ✅ リリースチェックリスト

- [ ] 全要件の実装完了
- [ ] 単体テストパス
- [ ] 50課題実験でKPI達成
- [ ] AGENTS.md更新
- [ ] package.json バージョン更新
- [ ] npm publish
- [ ] git tag v0.3.2

---

## 📝 備考

- v0.3.2は主に学習システムの品質改善に焦点
- 新機能追加は最小限に抑え、既存機能の最適化を優先
- 破壊的変更なし（後方互換性維持）

---

**作成者**: KATASHIRO Development Team  
**レビュー**: -  
**承認**: -
