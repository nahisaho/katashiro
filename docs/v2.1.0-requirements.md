# KATASHIRO v2.1.0 - Deep Research強化要件

> **参考**: [jina-ai/node-DeepResearch](https://github.com/jina-ai/node-DeepResearch)

## 概要

KATASHIROのDeep Research機能をjina-ai/node-DeepResearchのアーキテクチャを参考に強化する。
現在の`DeepResearchOrchestrator`と`WideResearchEngine`を拡張し、より洗練された反復調査フローを実現する。

---

## 1. エージェントアクションシステム（REQ-DR-001）

### 1.1 マルチアクションエージェント

jina-aiの5つのアクションタイプを参考に、より柔軟なアクション選択を実装：

| アクション | 説明 | 現状 | 優先度 |
|-----------|------|------|--------|
| `search` | Web検索でソースを収集 | ✅ 実装済み | - |
| `visit` | URLを訪問して詳細取得 | ✅ 実装済み（WebScraper） | - |
| `reflect` | 知識ギャップを分析し、サブ質問を生成 | ⚠️ 部分的（GapAnalyzer） | High |
| `answer` | 収集した情報から回答を生成 | ⚠️ 最終段階のみ | High |
| `coding` | コード実行で計算・変換処理 | ❌ 未実装 | Medium |

```typescript
// REQ-DR-001-001: アクションタイプ定義
type AgentAction = 
  | { action: 'search'; searchQueries: string[] }
  | { action: 'visit'; urlTargets: number[] }
  | { action: 'reflect'; questions: string[] }
  | { action: 'answer'; answer: string; references: Reference[]; isFinal?: boolean }
  | { action: 'coding'; codingIssue: string };

// REQ-DR-001-002: 各ステップでアクションを動的選択
interface StepDecision {
  think: string;  // 思考プロセスの説明
  action: AgentAction;
}
```

### 1.2 アクション許可/制限フラグ

各ステップで利用可能なアクションを動的に制御：

```typescript
// REQ-DR-001-003: アクション制御フラグ
interface ActionFlags {
  allowSearch: boolean;   // 検索許可
  allowVisit: boolean;    // URL訪問許可
  allowReflect: boolean;  // 振り返り許可
  allowAnswer: boolean;   // 回答許可
  allowCoding: boolean;   // コード実行許可
}
```

---

## 2. クエリリライティング（REQ-DR-002）

### 2.1 意図マイニング

jina-aiの5層意図分析を実装：

```typescript
// REQ-DR-002-001: 意図レイヤー
interface IntentLayers {
  surface: string;     // 1. 表面的な意図（文字通りの解釈）
  practical: string;   // 2. 実用的な意図（解決したい問題）
  emotional: string;   // 3. 感情的な意図（不安、好奇心など）
  social: string;      // 4. 社会的な意図（人間関係、立場）
  identity: string;    // 5. アイデンティティの意図（なりたい自分）
}

// REQ-DR-002-002: クエリリライター
interface QueryRewriter {
  rewrite(
    query: string, 
    context: string, 
    previousQueries: string[]
  ): Promise<RewrittenQuery[]>;
}

interface RewrittenQuery {
  q: string;
  tbs?: 'qdr:h' | 'qdr:d' | 'qdr:w' | 'qdr:m' | 'qdr:y';  // 時間フィルタ
  location?: string;  // 地域フィルタ
}
```

---

## 3. ナレッジアイテム蓄積（REQ-DR-003）

### 3.1 中間知識の管理

調査中に得た知識を構造化して蓄積：

```typescript
// REQ-DR-003-001: ナレッジアイテム
interface KnowledgeItem {
  question: string;          // 元の質問
  answer: string;            // 回答
  references?: string[];     // 参照URL
  type: 'url' | 'side-info' | 'user-provided';
  updated?: string;          // 更新日時
  confidence?: number;       // 信頼度
}

// REQ-DR-003-002: ナレッジをコンテキストとして活用
function buildMessagesFromKnowledge(knowledge: KnowledgeItem[]): Message[] {
  // 知識をQ&A形式のメッセージに変換
}
```

---

## 4. 回答評価システム（REQ-DR-004）

### 4.1 評価基準

生成された回答を複数の観点から評価：

```typescript
// REQ-DR-004-001: 評価レスポンス
interface EvaluationResponse {
  pass: boolean;
  think: string;
  type?: EvaluationType;
  freshnessAnalysis?: {
    daysAgo: number;
    maxAgeDays?: number;
  };
  pluralityAnalysis?: {
    minimumCountRequired: number;
    actualCountProvided: number;
  };
  completenessAnalysis?: {
    aspectsExpected: string;
    aspectsProvided: string;
  };
  improvementPlan?: string;
}

// REQ-DR-004-002: 評価タイプ
type EvaluationType =
  | 'definitive'     // 確定的な回答
  | 'freshness'      // 鮮度要件
  | 'plurality'      // 複数例の要件
  | 'completeness'   // 網羅性要件
  | 'attribution';   // 参照要件
```

### 4.2 自動評価フロー

```typescript
// REQ-DR-004-003: 回答評価器
interface AnswerEvaluator {
  evaluate(
    question: string,
    answer: string,
    references: Reference[],
    context: KnowledgeItem[]
  ): Promise<EvaluationResponse>;
}
```

---

## 5. エラー分析と学習（REQ-DR-005）

### 5.1 ステップ履歴の分析

失敗したステップを分析し、改善策を提案：

```typescript
// REQ-DR-005-001: エラー分析レスポンス
interface ErrorAnalysisResponse {
  recap: string;       // 状況の要約
  blame: string;       // 問題の特定
  improvement: string; // 改善策
}

// REQ-DR-005-002: エラー分析器
interface StepErrorAnalyzer {
  analyze(diaryContext: string[]): Promise<ErrorAnalysisResponse>;
}
```

### 5.2 ダイアリーコンテキスト

各ステップの記録を人間が読める形式で蓄積：

```typescript
// REQ-DR-005-003: ダイアリーエントリ
interface DiaryEntry {
  step: number;
  action: string;
  question: string;
  details: string;
  result: 'success' | 'partial' | 'failure';
  notes?: string;
}
```

---

## 6. チームリサーチ（REQ-DR-006）

### 6.1 サブ問題分解

複雑な質問を直交するサブ問題に分解：

```typescript
// REQ-DR-006-001: リサーチプランナー
interface ResearchPlanner {
  decompose(
    question: string,
    teamSize: number,
    soundBites: string  // 初期情報
  ): Promise<string[]>;
}

// 分解要件
// - 各サブ問題は4-6層の深さを持つ
// - サブ問題間の重複を最小化（直交性）
// - 全サブ問題でメイントピックの90%以上をカバー
```

### 6.2 並列リサーチ

```typescript
// REQ-DR-006-002: チームリサーチ実行
interface TeamResearchConfig {
  teamSize: number;           // 並列エージェント数（デフォルト: 3）
  maxDepthPerAgent: number;   // エージェントあたりの最大深度
  aggregationStrategy: 'merge' | 'vote' | 'consensus';
}
```

---

## 7. トークン予算管理（REQ-DR-007）

### 7.1 トークントラッカー

実行中のトークン消費を追跡：

```typescript
// REQ-DR-007-001: トークントラッカー
interface TokenTracker {
  trackUsage(tool: string, usage: TokenUsage): void;
  getTotalUsage(): number;
  getRemainingBudget(): number;
  getBreakdown(): Map<string, number>;
}

interface TokenUsage {
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;
}
```

### 7.2 予算ベースの終了制御

```typescript
// REQ-DR-007-002: 予算制御
interface BudgetConfig {
  tokenBudget: number;           // 総トークン予算
  reserveFinalRatio: number;     // 最終回答用リザーブ（デフォルト: 0.15）
  warningThreshold: number;      // 警告閾値
}
```

---

## 8. Beastモード（REQ-DR-008）

### 8.1 強制回答生成

予算切れ前に強制的に最良の回答を生成：

```typescript
// REQ-DR-008-001: Beastモード発動条件
interface BeastModeConfig {
  enabled: boolean;
  triggerThreshold: number;  // 残り予算比率（デフォルト: 0.15）
}

// REQ-DR-008-002: Beastモードプロンプト
// 「利用可能な情報から最良の回答を生成。不確実でも回答を出力」
```

---

## 9. 検索プロバイダー抽象化（REQ-DR-009）

### 9.1 複数プロバイダー対応

```typescript
// REQ-DR-009-001: 検索プロバイダー
type SearchProvider = 
  | 'duckduckgo'  // 現在のデフォルト
  | 'brave'       // Brave Search API
  | 'serper'      // Serper Google検索
  | 'jina'        // Jina Search
  | 'searxng';    // SearXNG

// REQ-DR-009-002: プロバイダー設定
interface SearchProviderConfig {
  provider: SearchProvider;
  apiKey?: string;
  baseUrl?: string;
}
```

---

## 10. 実装優先度

| 優先度 | 機能 | REQ ID | 工数見積 |
|--------|------|--------|----------|
| P0 | アクションシステム | REQ-DR-001 | 3日 |
| P0 | 回答評価システム | REQ-DR-004 | 2日 |
| P1 | クエリリライティング | REQ-DR-002 | 2日 |
| P1 | ナレッジ蓄積 | REQ-DR-003 | 1日 |
| P1 | トークン予算管理 | REQ-DR-007 | 1日 |
| P2 | エラー分析 | REQ-DR-005 | 2日 |
| P2 | チームリサーチ | REQ-DR-006 | 3日 |
| P2 | Beastモード | REQ-DR-008 | 1日 |
| P3 | 検索プロバイダー拡張 | REQ-DR-009 | 2日 |

---

## 11. 実装計画

### Phase 1: コアエージェントシステム（v2.1.0）
- REQ-DR-001: マルチアクションエージェント
- REQ-DR-004: 回答評価システム
- REQ-DR-007: トークン予算管理

### Phase 2: 知識管理強化（v2.2.0）
- REQ-DR-002: クエリリライティング
- REQ-DR-003: ナレッジアイテム蓄積
- REQ-DR-005: エラー分析

### Phase 3: 高度な機能（v2.3.0）
- REQ-DR-006: チームリサーチ
- REQ-DR-008: Beastモード
- REQ-DR-009: 検索プロバイダー拡張

---

## 12. 既存コードとの関係

| 既存モジュール | 拡張/修正内容 |
|--------------|--------------|
| `DeepResearchOrchestrator` | アクションシステム統合、評価ループ追加 |
| `WideResearchEngine` | 検索プロバイダー抽象化 |
| `GapAnalyzer` | reflectアクションとして統合 |
| `QueryGenerator` | クエリリライター統合 |
| `ConsensusResearchEngine` | チームリサーチ機能活用 |

---

## 13. 互換性

- **破壊的変更なし**: 既存のAPIは維持
- **新規エントリポイント**: `DeepResearchAgent`クラスを追加
- **段階的移行**: 旧APIは非推奨化し、新APIへの移行ガイドを提供
