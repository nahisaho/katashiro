# KATASHIRO v0.3.0 要件定義書

## 📋 概要

Wake-Sleep学習システムの実験結果（50仮想課題）に基づくKATASHIRO v0.3.0の改善計画。

## 📊 学習結果分析

### 実験データサマリー

| 指標 | 値 | 評価 |
|------|-----|------|
| 課題成功率 | 100% (50/50) | ✅ 良好 |
| パターン抽出数 | 50 → 14 | ⚠️ 重複が多い |
| Sleep後パターン数 | 5 | ⚠️ 過度に圧縮 |
| 圧縮率 | 64.3% | ⚠️ パターン多様性の損失 |
| MDL改善率 | 63.9% | ✅ 効率的な圧縮 |
| 平均パターン品質 | 0.897 | ✅ 高品質 |

### 特定された課題

1. **パターン抽出の精度**
   - 同一タイプ内で類似パターンが大量に生成される
   - 入力テンプレートが汎用的すぎる（例: `SEARCH: {{var1}}`）
   - コンテキスト情報が活用されていない

2. **パターンマッチング**
   - スコアが0.37-0.39の範囲に集中（識別力が低い）
   - キーワードマッチングの精度が不十分

3. **コンテキスト活用**
   - `domain`、`language`などのコンテキストが活用されていない
   - パターン検索時のフィルタリングが不十分

4. **user_feedback、citation_formatの未使用**
   - 2タイプが0パターン
   - フィードバックループが未実装

---

## 🎯 v0.3.0 改善目標

### 目標指標

| 指標 | 現状 | 目標 |
|------|------|------|
| パターン識別精度 | 低（同一タイプで類似） | 高（入力特性で差別化） |
| マッチングスコア分散 | 0.37-0.39 | 0.2-0.9（広い分布） |
| コンテキスト活用率 | 0% | 80%以上 |
| 圧縮後パターン保持率 | 35.7% | 60%以上 |

---

## 🔧 改善項目

### 1. パターン抽出の高度化（優先度: 高）

#### 1.1 入力テンプレートの改善

**現状**:
```
SEARCH: {{var1}}
TEXT_{{length}} {{topic}}
```

**改善後**:
```
SEARCH: {{domain}}:{{keyword1}} {{keyword2}} [{{modifier}}]
TEXT[{{domain}}]: length={{length}} topic={{topic}} entities={{entityTypes}}
```

**実装タスク**:
- [ ] `extractPatternsFromObservation()`のテンプレート生成ロジック改善
- [ ] ドメイン固有のテンプレートパターンを追加
- [ ] キーワード抽出の精度向上（TF-IDF、n-gram）

#### 1.2 コンテキスト活用強化

**実装タスク**:
- [ ] `ObservationContext`の拡張
- [ ] パターン検索時のコンテキストフィルタリング
- [ ] コンテキスト類似度スコアリング

### 2. パターンマッチング改善（優先度: 高）

#### 2.1 類似度計算の高度化

**現状**: 単純なキーワードマッチング + 品質ブースト

**改善後**:
- Jaccard類似度
- 編集距離（Levenshtein）
- TF-IDF コサイン類似度
- セマンティック類似度（オプション）

**実装タスク**:
- [ ] `calculateMatchScore()`の改善
- [ ] 複数の類似度指標の統合
- [ ] 重み付け調整可能な設定

#### 2.2 マッチング結果のランキング改善

**実装タスク**:
- [ ] スコア正規化
- [ ] コンテキスト一致ボーナス
- [ ] 時間減衰の調整

### 3. Sleepフェーズ最適化（優先度: 中）

#### 3.1 圧縮アルゴリズムの調整

**現状**: 類似度0.8以上でマージ → 過度な圧縮

**改善後**:
- 類似度閾値を動的に調整（0.85-0.95）
- タイプ別の圧縮戦略
- 最小パターン数保証

**実装タスク**:
- [ ] `PatternCompressor`の閾値パラメータ化
- [ ] タイプ別圧縮設定
- [ ] 最小多様性保証ロジック

#### 3.2 品質評価の改善

**実装タスク**:
- [ ] 多様性スコアの追加
- [ ] カバレッジスコア（入力空間のカバー率）
- [ ] 品質評価の重み調整

### 4. フィードバックループ実装（優先度: 中）

#### 4.1 ユーザーフィードバック収集

**実装タスク**:
- [ ] `recordFeedback()`メソッド追加
- [ ] フィードバックからのパターン品質更新
- [ ] ネガティブフィードバック処理

#### 4.2 自動フィードバック

**実装タスク**:
- [ ] 実行結果からの自動評価
- [ ] エラー率によるパターン品質調整
- [ ] A/Bテスト機能

### 5. Deep Research統合（優先度: 中）

#### 5.1 Deep Researchパターン学習

**実装タスク**:
- [ ] `deep_research`観察タイプの追加
- [ ] 反復検索パターンの学習
- [ ] 収束パターンの抽出

#### 5.2 推論チェーン学習

**実装タスク**:
- [ ] 推論ステップのパターン化
- [ ] 成功パターンの再利用

### 6. CLI/MCP統合（優先度: 低）

#### 6.1 CLIコマンド追加

```bash
# 学習モード
npx katashiro learn --input <file> --type <type>

# パターンマッチング
npx katashiro match --query <query> --type <type>

# ライブラリ管理
npx katashiro patterns list
npx katashiro patterns export <file>
npx katashiro patterns import <file>
npx katashiro patterns stats
```

#### 6.2 MCPツール追加

```typescript
// 新規MCPツール
wake_sleep_observe   // 観察を記録
wake_sleep_match     // パターンマッチング
wake_sleep_sleep     // Sleepフェーズ実行
wake_sleep_export    // ライブラリエクスポート
wake_sleep_import    // ライブラリインポート
wake_sleep_stats     // 統計取得
```

---

## 📦 リリース計画

### Phase 1: コア改善（v0.3.0-alpha）

| タスク | パッケージ | 工数 |
|--------|-----------|------|
| パターン抽出改善 | feedback | 2h |
| マッチングスコア改善 | feedback | 2h |
| 圧縮アルゴリズム調整 | feedback | 1h |
| テスト追加 | feedback | 1h |

### Phase 2: 統合・CLI（v0.3.0-beta）

| タスク | パッケージ | 工数 |
|--------|-----------|------|
| フィードバックループ | feedback | 2h |
| CLIコマンド追加 | katashiro | 2h |
| Deep Research統合 | collector | 2h |

### Phase 3: リリース（v0.3.0）

| タスク | パッケージ | 工数 |
|--------|-----------|------|
| ドキュメント更新 | all | 1h |
| 全パッケージビルド・テスト | all | 1h |
| npm publish | all | 0.5h |

---

## 🧪 検証計画

### 再実験

同じ50仮想課題でv0.3.0を実行し、以下を検証:

1. パターン識別精度の向上
2. マッチングスコアの分散拡大
3. 圧縮後パターン保持率の向上
4. 全体的な品質スコアの維持

### 成功基準

- [ ] 圧縮後パターン保持率 ≥ 60%
- [ ] マッチングスコア標準偏差 ≥ 0.15
- [ ] パターン品質スコア ≥ 0.85
- [ ] 全テスト通過

---

## 📝 変更ログ（予定）

### v0.3.0 (2026-01-13)

#### Added
- パターン抽出の高度化（ドメイン対応テンプレート）
- コンテキストベースのパターンフィルタリング
- 複合類似度スコアリング（Jaccard + TF-IDF）
- フィードバックループ（`recordFeedback()`）
- CLIコマンド: `learn`, `match`, `patterns`
- Deep Research観察タイプ

#### Changed
- `calculateMatchScore()`: 複合スコアリングに変更
- `PatternCompressor`: 動的閾値調整
- `PatternQualityEvaluator`: 多様性スコア追加

#### Fixed
- 過度なパターン圧縮問題
- マッチングスコアの低識別力問題

---

**作成日**: 2026-01-13
**作成者**: KATASHIRO Development Team
**バージョン**: v0.3.0 Requirements Draft
