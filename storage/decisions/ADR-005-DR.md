# ADR-005: DeepResearch機能改善アーキテクチャ

| 項目 | 内容 |
|------|------|
| ステータス | Accepted |
| 日付 | 2026-01-16 |
| 決定者 | KATASHIRO Team |
| 関連要件 | REQ-KATASHIRO-005-DR |

---

## コンテキスト

KATASHIRO DeepResearchを使用した「文部科学省AI for Science」調査プロジェクトにおいて、WebScraperによるコンテンツ取得の全面的失敗（0件成功）が発生した。主な課題：

1. リトライ機構の欠如によるネットワークエラーへの脆弱性
2. エラーハンドリングの不足による原因特定の困難さ
3. フォールバック機構の欠如によるリカバリー不能
4. 並列処理・キャッシング機能の不在によるパフォーマンス問題

これらの課題を解決するため、DeepResearch機能の抜本的な改善が必要となった。

---

## 決定

### ADR-005-001: コンポーネント分離アーキテクチャ

**決定**: 各機能を独立したコンポーネントとして分離し、疎結合な設計を採用する。

**理由**:
- テスト容易性の向上（各コンポーネントを単体でテスト可能）
- 再利用性の向上（RetryHandlerはWebScraper以外でも使用可能）
- 保守性の向上（変更影響範囲の局所化）

**コンポーネント一覧**:
| コンポーネント | 責務 |
|----------------|------|
| RetryHandler | リトライ制御・指数バックオフ |
| StructuredLogger | 構造化ログ出力 |
| SensitiveDataMasker | 機密情報マスキング |
| FallbackHandler | フォールバック戦略実行 |
| CacheManager | キャッシュ管理 |
| ParallelExecutor | 並列処理制御 |
| CheckpointManager | チェックポイント保存・復元 |
| DeepResearchOrchestrator | 全体統括 |

---

### ADR-005-002: Result型ベースエラーハンドリング

**決定**: 例外ではなくResult<T, E>型を使用してエラーを表現する。

**理由**:
- 明示的なエラー処理の強制（コンパイル時チェック）
- エラー情報の型安全性
- 関数型プログラミングスタイルとの親和性

**実装パターン**:
```typescript
type Result<T, E> = Ok<T> | Err<E>;

interface Ok<T> { readonly ok: true; readonly value: T; }
interface Err<E> { readonly ok: false; readonly error: E; }
```

---

### ADR-005-003: Zodスキーマによる設定検証

**決定**: すべての設定オブジェクトはZodスキーマで定義し、実行時検証を行う。

**理由**:
- 型安全性とランタイム検証の両立
- 自動的な型推論
- 詳細なエラーメッセージ

**適用箇所**:
- RetryPolicy
- LogConfig
- CacheConfig
- ParallelConfig
- CheckpointConfig

---

### ADR-005-004: フォールバック戦略のチェーン化

**決定**: 複数のフォールバック戦略を優先度付きでチェーン実行する。

**優先順位**:
1. ローカルキャッシュ
2. Internet Archive (Wayback Machine)
3. Readability.jsによる簡易パース
4. メタデータのみ抽出

**理由**:
- 段階的な劣化（Graceful Degradation）
- リソース効率（低コスト戦略から試行）
- 柔軟性（戦略の追加・変更が容易）

---

### ADR-005-005: LRUキャッシュ戦略

**決定**: キャッシュにはLRU（Least Recently Used）アルゴリズムを採用する。

**パラメータ**:
- 最大サイズ: 500MB
- 最小エントリ数: 100件
- デフォルトTTL: 24時間

**理由**:
- シンプルで予測可能な動作
- 最近使用されたデータの保持
- メモリ使用量の制御

---

### ADR-005-006: ドメイン別レート制限

**決定**: 同一ドメインへの並列リクエスト数を制限する。

**制限値**:
- デフォルト: 5並列/ドメイン
- 最小間隔: 200ms/リクエスト

**理由**:
- サーバー負荷の軽減
- アクセス制限（429エラー）の回避
- 倫理的なクローリング

---

### ADR-005-007: チェックポイント暗号化

**決定**: チェックポイントファイルはAES-256-GCMで暗号化する。

**理由**:
- 中間データに機密情報が含まれる可能性
- ファイルシステム上の安全性確保
- GDPR/個人情報保護への対応

**鍵管理**:
- 環境変数 `KATASHIRO_CHECKPOINT_KEY` から取得
- 未設定時は暗号化なし（開発環境向け）

---

## 影響

### ポジティブ

- コンテンツ取得成功率の大幅向上（目標: 80%以上）
- エラー原因の迅速な特定が可能
- 2回目以降の実行でキャッシュによる高速化
- 中断後の処理再開が可能

### ネガティブ

- コンポーネント数の増加による複雑性
- 初期実装コストの増加（見積: 192h）
- 依存ライブラリの追加（@mozilla/readability, zod等）

### リスク

| リスク | 対策 |
|--------|------|
| Internet Archive APIの可用性 | 複数フォールバック戦略 |
| 暗号化鍵の紛失 | ドキュメント整備、バックアップ推奨 |
| 過度な並列処理によるリソース枯渇 | ResourceMonitorによる動的調整 |

---

## 代替案

### 代替案1: 単一クラスでの実装

**却下理由**: テスト困難、変更影響範囲が広い、再利用性が低い

### 代替案2: 例外ベースエラーハンドリング

**却下理由**: エラー処理の見落とし、型安全性の欠如

### 代替案3: Redis等外部キャッシュ

**却下理由**: 依存関係の増加、ローカル実行の複雑化

---

## 参照

- [REQ-KATASHIRO-005-DR](../specs/REQ-KATASHIRO-005-DR.md)
- [DES-KATASHIRO-005-DR](../design/DES-KATASHIRO-005-DR.md)
- [TASK-KATASHIRO-005-DR](../tasks/TASK-KATASHIRO-005-DR.md)

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|------------|------|----------|--------|
| 1.0.0 | 2026-01-16 | 初版作成 | KATASHIRO Team |
