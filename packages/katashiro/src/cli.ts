#!/usr/bin/env node
/**
 * KATASHIRO CLI - AI Research & Analysis Tool
 *
 * @requirement REQ-CLI-001
 * @design DES-KATASHIRO-001 Â§2.6 CLI Interface
 */

import { Command } from 'commander';
import { createRequire } from 'module';
import { mkdir, writeFile } from 'fs/promises';
import { dirname, join } from 'path';
import { WebSearchClient, WebScraper, TextAnalyzer, EntityExtractor, SummaryGenerator, DeepResearchOrchestrator, isOk, isErr } from './index.js';
import {
  createContent,
  isValidFormat,
  isValidProvider,
  parseNumberOption,
  formatSearchResult,
  formatError,
  truncateText
} from './cli-helpers.js';

// package.json ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
const require = createRequire(import.meta.url);
const pkg = require('../package.json');

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã‘ã‚Œã°è‡ªå‹•ä½œæˆï¼‰
 */
async function saveReport(filePath: string, content: string): Promise<void> {
  const dir = dirname(filePath);
  await mkdir(dir, { recursive: true });
  await writeFile(filePath, content, 'utf-8');
}

/**
 * Deep Researchçµæœã‚’Markdownãƒ¬ãƒãƒ¼ãƒˆã«å¤‰æ›
 */
function generateMarkdownReport(topic: string, result: any, totalTime: string): string {
  const lines: string[] = [];
  const now = new Date().toISOString().split('T')[0];
  
  lines.push(`# ${topic} - Deep Research Report`);
  lines.push('');
  lines.push(`> Generated by KATASHIRO on ${now}`);
  lines.push('');
  
  // çµ±è¨ˆ
  lines.push('## ğŸ“ˆ çµ±è¨ˆ');
  lines.push('');
  lines.push(`- ç·ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${result.statistics.totalIterations}`);
  lines.push(`- ç·ç™ºè¦‹æ•°: ${result.statistics.totalFindingsProcessed}`);
  lines.push(`- ç·ãƒãƒ¼ãƒ‰æ•°: ${result.statistics.totalNodesCreated}`);
  lines.push(`- å¹³å‡æ–°è¦æƒ…å ±ç‡: ${(result.statistics.averageNoveltyRate * 100).toFixed(1)}%`);
  lines.push(`- å‡¦ç†æ™‚é–“: ${totalTime}ç§’`);
  lines.push('');
  
  // ä¸»è¦ãªç™ºè¦‹
  lines.push('## ğŸ“‹ ä¸»è¦ãªç™ºè¦‹');
  lines.push('');
  result.keyFindings.forEach((finding: any, i: number) => {
    lines.push(`### ${i + 1}. ${finding.title}`);
    lines.push('');
    lines.push(finding.summary);
    lines.push('');
  });
  
  // æ¨è«–ãƒã‚§ãƒ¼ãƒ³
  if (result.reasoningChain && result.reasoningChain.length > 0) {
    lines.push('## ğŸ§  æ¨è«–ãƒã‚§ãƒ¼ãƒ³');
    lines.push('');
    result.reasoningChain.forEach((step: any) => {
      const typeLabels: Record<string, string> = {
        observation: 'ğŸ“Š è¦³å¯Ÿ',
        inference: 'ğŸ’­ æ¨è«–',
        synthesis: 'ğŸ”— çµ±åˆ',
        conclusion: 'âœ… çµè«–',
      };
      const label = typeLabels[step.type] || step.type;
      lines.push(`${step.step}. **[${label}]** ${step.description} (ä¿¡é ¼åº¦: ${(step.confidence * 100).toFixed(0)}%)`);
      lines.push('');
    });
  }
  
  // Mermaidãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ 
  if (result.mermaidDiagrams) {
    lines.push('## ğŸ“Š ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ');
    lines.push('');
    
    lines.push('### ãƒŠãƒ¬ãƒƒã‚¸ã‚°ãƒ©ãƒ•');
    lines.push('```mermaid');
    lines.push(result.mermaidDiagrams.knowledgeGraph);
    lines.push('```');
    lines.push('');
    
    lines.push('### æ¨è«–ãƒ•ãƒ­ãƒ¼');
    lines.push('```mermaid');
    lines.push(result.mermaidDiagrams.reasoningFlow);
    lines.push('```');
    lines.push('');
    
    lines.push('### èª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹');
    lines.push('```mermaid');
    lines.push(result.mermaidDiagrams.researchProcess);
    lines.push('```');
    lines.push('');
    
    lines.push('### ç™ºè¦‹äº‹é …ã®é–¢ä¿‚');
    lines.push('```mermaid');
    lines.push(result.mermaidDiagrams.findingsRelation);
    lines.push('```');
    lines.push('');
  }
  
  // æƒ…å ±ã‚½ãƒ¼ã‚¹
  lines.push('## ğŸ”— æƒ…å ±ã‚½ãƒ¼ã‚¹');
  lines.push('');
  result.sources.forEach((source: any, i: number) => {
    lines.push(`${i + 1}. [${source.title}](${source.url})`);
  });
  lines.push('');
  
  return lines.join('\n');
}

const program = new Command();

program
  .name('katashiro')
  .description('KATASHIRO CLI - AI Research & Analysis Tool')
  .version(pkg.version, '-v, --version', 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤º');

// æ¤œç´¢ã‚³ãƒãƒ³ãƒ‰
program
  .command('search <query>')
  .description('Webæ¤œç´¢ã‚’å®Ÿè¡Œ')
  .option('-n, --max <number>', 'çµæœã®æœ€å¤§ä»¶æ•°', '10')
  .option('-p, --provider <provider>', 'æ¤œç´¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (duckduckgo|searxng)', 'duckduckgo')
  .option('-f, --format <format>', 'å‡ºåŠ›å½¢å¼ (json|text)', 'text')
  .action(async (query: string, options: { max: string; provider: string; format: string }) => {
    try {
      const client = new WebSearchClient();
      const provider = options.provider as 'duckduckgo' | 'searxng';
      const results = await client.search(query, { 
        maxResults: parseInt(options.max, 10),
        provider
      });
      
      if (options.format === 'json') {
        console.log(JSON.stringify(results, null, 2));
      } else {
        console.log(`\nğŸ” "${query}" ã®æ¤œç´¢çµæœ: ${results.length}ä»¶\n`);
        for (const r of results) {
          console.log(`ğŸ“„ ${r.title}`);
          console.log(`   ${r.url}`);
          if (r.snippet) {
            console.log(`   ${r.snippet.substring(0, 100)}...`);
          }
          console.log();
        }
      }
    } catch (error) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
      process.exit(1);
    }
  });

// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚³ãƒãƒ³ãƒ‰
program
  .command('scrape <url>')
  .description('Webãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’å–å¾—')
  .option('-f, --format <format>', 'å‡ºåŠ›å½¢å¼ (json|text)', 'text')
  .option('-s, --summary', 'è¦ç´„ã‚’è¡¨ç¤º', false)
  .action(async (url: string, options: { format: string; summary: boolean }) => {
    try {
      const scraper = new WebScraper();
      const result = await scraper.scrape(url);
      
      if (isErr(result)) {
        console.error('âŒ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ—ã‚¨ãƒ©ãƒ¼:', result.error.message);
        process.exit(1);
      }

      const page = result.value;
      
      if (options.format === 'json') {
        console.log(JSON.stringify(page, null, 2));
      } else {
        console.log(`\nğŸ“„ ${page.title}`);
        console.log(`ğŸ”— ${page.url}`);
        console.log('\n---\n');
        
        if (options.summary) {
          const summarizer = new SummaryGenerator();
          const content = createContent(page.title, page.content, page.url);
          const summary = await summarizer.generateSummary(content, { maxLength: 500 });
          if (isOk(summary)) {
            console.log('ğŸ“ è¦ç´„:\n');
            console.log(summary.value);
          }
        } else {
          console.log(page.content.substring(0, 2000));
          if (page.content.length > 2000) {
            console.log(`\n... (${page.content.length - 2000}æ–‡å­—çœç•¥)`);
          }
        }
      }
    } catch (error) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
      process.exit(1);
    }
  });

// åˆ†æã‚³ãƒãƒ³ãƒ‰
program
  .command('analyze <text>')
  .description('ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†æï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»æ„Ÿæƒ…åˆ†æï¼‰')
  .option('-f, --format <format>', 'å‡ºåŠ›å½¢å¼ (json|text)', 'text')
  .action(async (text: string, options: { format: string }) => {
    try {
      const analyzer = new TextAnalyzer();
      const result = await analyzer.analyze(text);
      
      if (options.format === 'json') {
        console.log(JSON.stringify(result, null, 2));
      } else {
        console.log('\nğŸ“Š ãƒ†ã‚­ã‚¹ãƒˆåˆ†æçµæœ\n');
        console.log(`ğŸ”‘ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${result.keywords.join(', ')}`);
        console.log(`ğŸ’¬ æ„Ÿæƒ…: ${result.sentiment.sentiment}`);
        console.log(`ğŸ“ˆ æ„Ÿæƒ…ã‚¹ã‚³ã‚¢: ${result.sentiment.score.toFixed(2)}`);
        console.log(`ğŸ“ è¤‡é›‘åº¦: ${result.complexity.level} (${result.complexity.score})`);
        console.log(`ğŸ“„ å˜èªæ•°: ${result.wordCount}`);
        console.log(`ğŸ“„ æ–‡æ•°: ${result.sentenceCount}`);
      }
    } catch (error) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
      process.exit(1);
    }
  });

// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡ºã‚³ãƒãƒ³ãƒ‰
program
  .command('extract <text>')
  .description('ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æŠ½å‡º')
  .option('-f, --format <format>', 'å‡ºåŠ›å½¢å¼ (json|text)', 'text')
  .action(async (text: string, options: { format: string }) => {
    try {
      const extractor = new EntityExtractor();
      const entities = await extractor.extract(text);
      
      if (options.format === 'json') {
        console.log(JSON.stringify(entities, null, 2));
      } else {
        console.log('\nğŸ” ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡ºçµæœ\n');
        
        if (entities.persons.length > 0) {
          console.log(`ğŸ‘¤ äººå: ${entities.persons.join(', ')}`);
        }
        if (entities.organizations.length > 0) {
          console.log(`ğŸ¢ çµ„ç¹”: ${entities.organizations.join(', ')}`);
        }
        if (entities.locations.length > 0) {
          console.log(`ğŸ“ å ´æ‰€: ${entities.locations.join(', ')}`);
        }
        if (entities.dates.length > 0) {
          console.log(`ğŸ“… æ—¥ä»˜: ${entities.dates.join(', ')}`);
        }
        if (entities.urls.length > 0) {
          console.log(`ğŸ”— URL: ${entities.urls.join(', ')}`);
        }
        if (entities.emails.length > 0) {
          console.log(`ğŸ“§ ãƒ¡ãƒ¼ãƒ«: ${entities.emails.join(', ')}`);
        }
        if (entities.phones.length > 0) {
          console.log(`ğŸ“ é›»è©±: ${entities.phones.join(', ')}`);
        }
        if (entities.money.length > 0) {
          console.log(`ğŸ’° é‡‘é¡: ${entities.money.join(', ')}`);
        }
        
        console.log(`\nğŸ“Š åˆè¨ˆ: ${entities.all.length}ä»¶ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£`);
      }
    } catch (error) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
      process.exit(1);
    }
  });

// è¦ç´„ã‚³ãƒãƒ³ãƒ‰
program
  .command('summarize <text>')
  .description('ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦ç´„')
  .option('-l, --length <number>', 'è¦ç´„ã®æœ€å¤§æ–‡å­—æ•°', '300')
  .option('-f, --format <format>', 'å‡ºåŠ›å½¢å¼ (json|text)', 'text')
  .action(async (text: string, options: { length: string; format: string }) => {
    try {
      const summarizer = new SummaryGenerator();
      const content = createContent('CLI Input', text);
      const result = await summarizer.generateSummary(content, { maxLength: parseInt(options.length, 10) });
      
      if (isErr(result)) {
        const error = result.error as Error;
        console.error('âŒ è¦ç´„ã‚¨ãƒ©ãƒ¼:', error.message);
        process.exit(1);
      }

      const summary = result.value;
      
      if (options.format === 'json') {
        console.log(JSON.stringify({ summary, originalLength: text.length }, null, 2));
      } else {
        console.log('\nğŸ“ è¦ç´„çµæœ\n');
        console.log(summary);
        console.log(`\n(å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ: ${text.length}æ–‡å­— â†’ è¦ç´„: ${summary.length}æ–‡å­—)`);
      }
    } catch (error) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
      process.exit(1);
    }
  });

// =============================================================================
// deep-research ã‚³ãƒãƒ³ãƒ‰
// =============================================================================
program
  .command('deep-research <topic>')
  .description('Deep Research - åå¾©çš„ãªæ·±æ˜ã‚Šèª¿æŸ»ã‚’å®Ÿè¡Œ')
  .option('-i, --iterations <number>', 'æœ€å¤§ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°', '5')
  .option('-t, --threshold <number>', 'åæŸé–¾å€¤ (0.0-1.0)', '0.15')
  .option('-f, --focus <areas>', 'ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¨ãƒªã‚¢ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)')
  .option('--format <type>', 'å‡ºåŠ›å½¢å¼ (text/json)', 'text')
  .option('-o, --output <path>', 'ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜å…ˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ./Reports/<topic>.md)')
  .action(async (topic: string, options: { iterations: string; threshold: string; focus?: string; format: string; output?: string }) => {
    try {
      console.log(`\nğŸ”¬ Deep Research: "${topic}"\n`);
      console.log('è¨­å®š:');
      console.log(`  - æœ€å¤§ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${options.iterations}`);
      console.log(`  - åæŸé–¾å€¤: ${options.threshold}`);
      if (options.focus) {
        console.log(`  - ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¨ãƒªã‚¢: ${options.focus}`);
      }
      console.log('\nèª¿æŸ»ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...\n');

      const orchestrator = new DeepResearchOrchestrator();
      const startTime = Date.now();

      // AsyncGenerator ã‚’ä½¿ç”¨ã—ã¦åå¾©çš„ã«çµæœã‚’å–å¾—
      for await (const state of orchestrator.research({
        topic,
        maxIterations: parseInt(options.iterations, 10),
        convergenceThreshold: parseFloat(options.threshold),
        focusAreas: options.focus ? options.focus.split(',').map(s => s.trim()) : undefined,
      })) {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        
        console.log(`ğŸ“Š ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ${state.iteration}/${options.iterations} (${elapsed}s)`);
        console.log(`   ãƒ•ã‚§ãƒ¼ã‚º: ${state.phase}`);
        console.log(`   ç´¯è¨ˆç™ºè¦‹æ•°: ${state.totalFindingsCount}`);
        console.log(`   æ–°è¦æƒ…å ±ç‡: ${(state.noveltyRate * 100).toFixed(1)}%`);
        console.log(`   åæŸã‚¹ã‚³ã‚¢: ${(state.convergenceScore * 100).toFixed(1)}%`);
        
        if (state.gaps && state.gaps.length > 0) {
          const gapDescriptions = state.gaps.slice(0, 3).map(g => g.description);
          console.log(`   ã‚®ãƒ£ãƒƒãƒ—: ${gapDescriptions.join(', ')}${state.gaps.length > 3 ? '...' : ''}`);
        }
        console.log();
      }

      // æœ€çµ‚çµæœã‚’å–å¾—
      const result = orchestrator.getResult();
      const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);

      if (!result) {
        console.error('âŒ çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        process.exit(1);
      }

      if (options.format === 'json') {
        console.log(JSON.stringify(result, null, 2));
      } else {
        console.log('â”'.repeat(60));
        console.log('ğŸ¯ Deep Research å®Œäº†\n');
        console.log(`ğŸ“ˆ çµ±è¨ˆ:`);
        console.log(`   - ç·ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${result.statistics.totalIterations}`);
        console.log(`   - ç·ç™ºè¦‹æ•°: ${result.statistics.totalFindingsProcessed}`);
        console.log(`   - ç·ãƒãƒ¼ãƒ‰æ•°: ${result.statistics.totalNodesCreated}`);
        console.log(`   - å¹³å‡æ–°è¦æƒ…å ±ç‡: ${(result.statistics.averageNoveltyRate * 100).toFixed(1)}%`);
        console.log(`   - å‡¦ç†æ™‚é–“: ${totalTime}ç§’`);
        
        console.log('\nğŸ“‹ ä¸»è¦ãªç™ºè¦‹:');
        result.keyFindings.slice(0, 10).forEach((finding, i) => {
          console.log(`   ${i + 1}. ${finding.title}: ${finding.summary}`);
        });
        
        if (result.keyFindings.length > 10) {
          console.log(`   ... ä»– ${result.keyFindings.length - 10} ä»¶`);
        }
        
        // æ¨è«–ãƒã‚§ãƒ¼ãƒ³ï¼ˆè«–ç†çš„èª¬æ˜ï¼‰ã‚’è¡¨ç¤º
        if (result.reasoningChain && result.reasoningChain.length > 0) {
          console.log('\nğŸ§  æ¨è«–ãƒã‚§ãƒ¼ãƒ³ï¼ˆçµè«–ã«è‡³ã£ãŸè«–ç†çš„èª¬æ˜ï¼‰:');
          result.reasoningChain.forEach((step) => {
            const typeLabels: Record<string, string> = {
              observation: 'ğŸ“Š è¦³å¯Ÿ',
              inference: 'ğŸ’­ æ¨è«–',
              synthesis: 'ğŸ”— çµ±åˆ',
              conclusion: 'âœ… çµè«–',
            };
            const label = typeLabels[step.type] || step.type;
            console.log(`   ${step.step}. [${label}] ${step.description}`);
            console.log(`      ä¿¡é ¼åº¦: ${(step.confidence * 100).toFixed(0)}%`);
          });
        }
        
        // Mermaidãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã‚’è¡¨ç¤º
        if (result.mermaidDiagrams) {
          console.log('\nğŸ“Š Mermaidãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ :');
          
          console.log('\n### ãƒŠãƒ¬ãƒƒã‚¸ã‚°ãƒ©ãƒ• (mindmap)');
          console.log('```mermaid');
          console.log(result.mermaidDiagrams.knowledgeGraph);
          console.log('```');
          
          console.log('\n### æ¨è«–ãƒ•ãƒ­ãƒ¼ (flowchart)');
          console.log('```mermaid');
          console.log(result.mermaidDiagrams.reasoningFlow);
          console.log('```');
          
          console.log('\n### èª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹ (sequence)');
          console.log('```mermaid');
          console.log(result.mermaidDiagrams.researchProcess);
          console.log('```');
          
          console.log('\n### ç™ºè¦‹äº‹é …ã®é–¢ä¿‚ (graph)');
          console.log('```mermaid');
          console.log(result.mermaidDiagrams.findingsRelation);
          console.log('```');
        }
        
        console.log('\nğŸ”— æƒ…å ±ã‚½ãƒ¼ã‚¹:');
        result.sources.slice(0, 5).forEach((source, i) => {
          console.log(`   ${i + 1}. ${source.title} (${source.url})`);
        });
        
        if (result.sources.length > 5) {
          console.log(`   ... ä»– ${result.sources.length - 5} ä»¶`);
        }
        
        // ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        const sanitizedTopic = topic.replace(/[<>:"/\\|?*]/g, '_').substring(0, 50);
        const outputPath = options.output || join('Reports', `${sanitizedTopic}.md`);
        
        // Markdownãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        const reportContent = generateMarkdownReport(topic, result, totalTime);
        await saveReport(outputPath, reportContent);
        console.log(`\nğŸ“ ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜: ${outputPath}`);
        
        console.log('\nğŸ’¡ ãƒ’ãƒ³ãƒˆ: --format json ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å®Œå…¨ãªçµæœã‚’å–å¾—ã§ãã¾ã™');
      }
    } catch (error) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : error);
      process.exit(1);
    }
  });

program.parse();
